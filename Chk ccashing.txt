import { useState, useEffect, useRef, createContext, useContext } from 'react';
import {
  DollarSign,
  Receipt,
  User,
  CheckCircle,
  History,
  Info,
  Camera,
  Scan,
  RotateCcw,
  BadgeCheck,
  XCircle,
  FileText,
  BadgePlus,
  ArrowRightCircle,
  ClipboardList,
  Search,
  Database,
  LayoutDashboard,
  Settings,
  Home,
  LogOut,
  LogIn,
  Users,
  UserPlus
} from 'lucide-react';
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  Legend
} from 'recharts';

// Firebase imports
import { initializeApp } from 'firebase/app';
import {
  getAuth,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
  createUserWithEmailAndPassword
} from 'firebase/auth';
import {
  getFirestore,
  collection,
  doc,
  addDoc,
  onSnapshot,
  getDoc,
  query,
  getDocs,
  collectionGroup
} from 'firebase/firestore';

// Define a context for the user and authentication state
const UserContext = createContext(null);

// Main application component
const App = () => {
  // --- Firebase State ---
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [user, setUser] = useState(null);
  const [userRole, setUserRole] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);

  // --- App State ---
  const [checkAmount, setCheckAmount] = useState('');
  const [customerName, setCustomerName] = useState('');
  const [checkType, setCheckType] = useState('payroll');
  
  const [fee, setFee] = useState(0);
  const [cashOut, setCashOut] = useState(0);
  
  const [transactions, setTransactions] = useState([]);
  const [activeTab, setActiveTab] = useState('new-transaction');

  // --- Dashboard State ---
  const [totalCashedAmount, setTotalCashedAmount] = useState(0);
  const [totalChecksCashed, setTotalChecksCashed] = useState(0);
  const [newCustomers, setNewCustomers] = useState(0);
  const [repeatedCustomers, setRepeatedCustomers] = useState(0);
  
  // --- Reports State ---
  const [reportStartDate, setReportStartDate] = useState('');
  const [reportEndDate, setReportEndDate] = useState('');
  const [filteredTransactions, setFilteredTransactions] = useState([]);
  const [reportData, setReportData] = useState([]);
  const [checkTypePieData, setCheckTypePieData] = useState([]);

  // --- Search State ---
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  const [selectedTransaction, setSelectedTransaction] = useState(null);
  const [allTransactions, setAllTransactions] = useState([]);

  // --- UI/Camera State ---
  const [isValid, setIsValid] = useState(false);
  const [isCashed, setIsCashed] = useState(false);
  const [showCamera, setShowCamera] = useState(false);
  const [loading, setLoading] = useState(false);
  const [cameraError, setCameraError] = useState('');
  const [captureStage, setCaptureStage] = useState('check');
  const [checkImage, setCheckImage] = useState(null);
  const [idImage, setIdImage] = useState(null);
  const [extractedCheckName, setExtractedCheckName] = useState('');
  const [extractedCheckNumber, setExtractedCheckNumber] = useState('');
  const [extractedIDName, setExtractedIDName] = useState('');
  const [verificationStatus, setVerificationStatus] = useState('unverified');

  // --- Auth UI State ---
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [authError, setAuthError] = useState('');
  const [isSignUp, setIsSignUp] = useState(false);

  // Hardcoded Admin User ID for demonstration
  // IMPORTANT: Replace this with your own admin's user ID from Firebase
  const isAdmin = userRole === 'admin';

  // Refs for the video and canvas elements
  const videoRef = useRef(null);
  const canvasRef = useRef(null);

  // Fee structure
  const feeStructure = {
    payroll: 0.02,
    government: 0.015,
    personal: 0.05,
  };

  // --- Firebase Initialization and Authentication ---
  useEffect(() => {
    try {
      const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
      
      const firebaseApp = initializeApp(firebaseConfig);
      const firestore = getFirestore(firebaseApp);
      const firebaseAuth = getAuth(firebaseApp);
      
      setDb(firestore);
      setAuth(firebaseAuth);

      onAuthStateChanged(firebaseAuth, async (currentUser) => {
        if (currentUser) {
          setUser(currentUser);
          // Fetch user role from Firestore
          const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
          const userDocRef = doc(firestore, `/artifacts/${appId}/users/${currentUser.uid}`);
          const userDoc = await getDoc(userDocRef);
          if (userDoc.exists()) {
            setUserRole(userDoc.data().role);
          } else {
            // Assign default role if not found (e.g., 'cashier')
            await setDoc(userDocRef, { role: 'cashier', createdAt: new Date().toISOString() });
            setUserRole('cashier');
          }
        } else {
          setUser(null);
          setUserRole(null);
        }
        setIsAuthReady(true);
      });

    } catch (e) {
      console.error("Firebase init failed:", e);
    }
  }, []);

  // --- Firestore Real-Time Data Listener for current user's transactions ---
  useEffect(() => {
    if (db && user) {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const transactionsCollectionRef = collection(db, `/artifacts/${appId}/users/${user.uid}/transactions`);

      const unsubscribe = onSnapshot(transactionsCollectionRef, (snapshot) => {
        const newTransactions = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setTransactions(newTransactions);
        setSearchResults(newTransactions);
      }, (error) => {
        console.error("Error fetching transactions: ", error);
      });

      return () => unsubscribe();
    } else {
      setTransactions([]);
      setSearchResults([]);
    }
  }, [db, user]);

  // --- Admin Dashboard: Fetch all transactions from all users ---
  useEffect(() => {
      if (db && isAdmin) {
          const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
          const transactionsCollectionGroupRef = collectionGroup(db, 'transactions');
          
          const unsubscribe = onSnapshot(transactionsCollectionGroupRef, (snapshot) => {
              const allDocs = snapshot.docs.map(doc => ({
                  id: doc.id,
                  userId: doc.ref.parent.parent.id, // Extract the parent user ID
                  ...doc.data()
              }));
              setAllTransactions(allDocs);
          }, (error) => {
              console.error("Error fetching all transactions for admin: ", error);
          });
          return () => unsubscribe();
      }
  }, [db, isAdmin]);

  // Effect to validate the form, calculate fees, and check name verification
  useEffect(() => {
    const amount = parseFloat(checkAmount);
    const name = customerName.trim();
    
    if (amount > 0 && name.length > 0 && verificationStatus === 'match') {
      setIsValid(true);
      
      let calculatedFee = amount * feeStructure[checkType];
      if (calculatedFee < 5) {
        calculatedFee = 5;
      }
      
      const calculatedCashOut = amount - calculatedFee;
      
      setFee(calculatedFee);
      setCashOut(calculatedCashOut);
    } else {
      setIsValid(false);
      setFee(0);
      setCashOut(0);
    }
    
    setIsCashed(false);
  }, [checkAmount, customerName, checkType, verificationStatus]);

  // Effect to verify names after both check and ID are captured
  useEffect(() => {
    if (extractedCheckName && extractedIDName) {
      if (extractedCheckName.toLowerCase() === extractedIDName.toLowerCase()) {
        setVerificationStatus('match');
        setCustomerName(extractedIDName);
      } else {
        setVerificationStatus('mismatch');
      }
    }
  }, [extractedCheckName, extractedIDName]);

  // Effect to calculate dashboard metrics whenever transactions change
  useEffect(() => {
    let totalAmount = 0;
    let repeatedCount = 0;
    const uniqueCustomers = new Set();
    
    transactions.forEach(transaction => {
        totalAmount += transaction.amount;
        if (uniqueCustomers.has(transaction.customer)) {
            repeatedCount++;
        }
        uniqueCustomers.add(transaction.customer);
    });

    setTotalChecksCashed(transactions.length);
    setTotalCashedAmount(totalAmount);
    setNewCustomers(uniqueCustomers.size);
    setRepeatedCustomers(repeatedCount);
  }, [transactions]);

  // Effect to handle search
  useEffect(() => {
    const transactionsToSearch = activeTab === 'admin-dashboard' ? allTransactions : transactions;

    if (searchQuery.trim() === '') {
      setSearchResults(transactionsToSearch);
    } else {
      const lowerCaseQuery = searchQuery.toLowerCase();
      const results = transactionsToSearch.filter(t =>
        (t.customer?.toLowerCase() || '').includes(lowerCaseQuery) ||
        (t.checkNumber?.toLowerCase() || '').includes(lowerCaseQuery) ||
        (t.amount?.toString() || '').includes(lowerCaseQuery) ||
        (t.type?.toLowerCase() || '').includes(lowerCaseQuery)
      );
      setSearchResults(results);
    }
  }, [searchQuery, transactions, allTransactions, activeTab]);

  // Function to handle the check cashing submission
  const handleCashCheck = async (e) => {
    e.preventDefault();
    if (isValid && db && user) {
      const newTransaction = {
        customer: customerName,
        checkNumber: extractedCheckNumber,
        amount: parseFloat(checkAmount),
        fee: fee,
        cashOut: cashOut,
        type: checkType,
        timestamp: new Date().toLocaleString(),
        checkImage: checkImage,
        idImage: idImage
      };
      
      try {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const transactionsCollectionRef = collection(db, `/artifacts/${appId}/users/${user.uid}/transactions`);
        await addDoc(transactionsCollectionRef, newTransaction);
        
        setIsCashed(true);
        setCheckAmount('');
        setCustomerName('');
        setCheckType('payroll');
        setExtractedCheckName('');
        setExtractedCheckNumber('');
        setExtractedIDName('');
        setVerificationStatus('unverified');
        setCheckImage(null);
        setIdImage(null);
      } catch (error) {
        console.error("Error adding document: ", error);
        setCameraError('Failed to save transaction. Please try again.');
      }
    }
  };

  // --- Camera and OCR Logic ---
  const startCamera = async (stage) => {
    setLoading(true);
    setCameraError('');
    setShowCamera(true);
    setCaptureStage(stage);
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        videoRef.current.play();
      }
    } catch (err) {
      console.error("Error accessing camera:", err);
      setCameraError('Could not access camera. Please check permissions.');
    } finally {
      setLoading(false);
    }
  };

  const stopCamera = () => {
    if (videoRef.current && videoRef.current.srcObject) {
      videoRef.current.srcObject.getTracks().forEach(track => track.stop());
      videoRef.current.srcObject = null;
    }
    setShowCamera(false);
  };
  
  const captureImage = () => {
    if (videoRef.current && canvasRef.current) {
      const video = videoRef.current;
      const canvas = canvasRef.current;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
      const imageData = canvas.toDataURL('image/png').split(',')[1];
      stopCamera();
      if (captureStage === 'check') {
        setCheckImage(imageData);
        readCheckInfo(imageData);
      } else {
        setIdImage(imageData);
        readIDInfo(imageData);
      }
    }
  };

  const readCheckInfo = async (base64ImageData) => {
    setLoading(true);
    try {
      const promptText = "Extract the name from the 'Pay to the order of' line, the numerical amount, and the check number from this check. Return a JSON object with 'customerName', 'checkAmount', and 'checkNumber' as keys. Only return the JSON object.";
      
      const payload = {
        contents: [
          {
            role: "user",
            parts: [
              { text: promptText },
              {
                inlineData: {
                  mimeType: "image/png",
                  data: base64ImageData
                }
              }
            ]
          }
        ],
        generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
                type: "OBJECT",
                properties: {
                    "customerName": { "type": "STRING" },
                    "checkAmount": { "type": "STRING" },
                    "checkNumber": { "type": "STRING" }
                }
            }
        }
      };
      
      const apiKey = "";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();
      
      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const jsonResponse = result.candidates[0].content.parts[0].text;
        const parsedJson = JSON.parse(jsonResponse);
        setExtractedCheckName(parsedJson.customerName || '');
        setCheckAmount(parsedJson.checkAmount || '');
        setExtractedCheckNumber(parsedJson.checkNumber || 'N/A');
      } else {
        setCameraError('Could not extract check info. Please try again.');
      }
    } catch (error) {
      console.error("Error calling Gemini API for check:", error);
      setCameraError('An error occurred while processing the check image.');
    } finally {
      setLoading(false);
    }
  };

  const readIDInfo = async (base64ImageData) => {
    setLoading(true);
    try {
      const promptText = "Extract the full name from this ID. Return only the full name as a string.";
      
      const payload = {
        contents: [
          {
            role: "user",
            parts: [
              { text: promptText },
              {
                inlineData: {
                  mimeType: "image/png",
                  data: base64ImageData
                }
              }
            ]
          }
        ],
      };
      const apiKey = "";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();
      
      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const extractedName = result.candidates[0].content.parts[0].text;
        setExtractedIDName(extractedName.replace(/["']+/g, '').trim());
      } else {
        setCameraError('Could not extract name from ID. Please try again.');
      }
    } catch (error) {
      console.error("Error calling Gemini API for ID:", error);
      setCameraError('An error occurred while processing the ID image.');
    } finally {
      setLoading(false);
    }
  };
  
  const handleResetCapture = () => {
    setCheckImage(null);
    setIdImage(null);
    setExtractedCheckName('');
    setExtractedCheckNumber('');
    setExtractedIDName('');
    setVerificationStatus('unverified');
    setCustomerName('');
    setCheckAmount('');
  };

  const generateReport = () => {
    const start = reportStartDate ? new Date(reportStartDate) : new Date(0);
    const end = reportEndDate ? new Date(reportEndDate) : new Date();
    
    end.setHours(23, 59, 59, 999);
    
    const filtered = transactions.filter(t => {
      const transactionDate = new Date(t.timestamp);
      return transactionDate >= start && transactionDate <= end;
    });

    setFilteredTransactions(filtered);

    // Prepare data for the bar chart
    const dailyData = filtered.reduce((acc, t) => {
      const date = t.timestamp.split(',')[0].trim();
      acc[date] = (acc[date] || 0) + t.amount;
      return acc;
    }, {});
    
    const chartData = Object.keys(dailyData).map(date => ({
      date,
      amount: dailyData[date]
    }));
    setReportData(chartData);

    // Prepare data for the pie chart
    const typeData = filtered.reduce((acc, t) => {
      acc[t.type] = (acc[t.type] || 0) + t.amount;
      return acc;
    }, {});

    const pieData = Object.keys(typeData).map(key => ({
      name: key.charAt(0).toUpperCase() + key.slice(1),
      value: parseFloat(typeData[key].toFixed(2))
    }));
    setCheckTypePieData(pieData);
  };
  
  const DashboardCard = ({ title, value, icon, className }) => (
    <div className={`p-6 rounded-2xl shadow-lg border border-slate-200 flex flex-col items-center justify-center text-center transition-transform transform hover:scale-105 ${className}`}>
      <div className="text-4xl mb-2">{icon}</div>
      <h3 className="text-xl font-bold text-slate-900 mb-1">{title}</h3>
      <p className="text-3xl font-extrabold text-indigo-600">
        {typeof value === 'number' ? (value % 1 === 0 ? value : `$${value.toFixed(2)}`) : value}
      </p>
    </div>
  );

  const ReportCard = ({ title, value, icon, className }) => (
    <div className={`p-4 rounded-xl border border-slate-300 flex items-center justify-between transition-transform transform hover:scale-105 ${className}`}>
      <div className="flex items-center gap-4">
        <div className="text-2xl">{icon}</div>
        <h3 className="text-lg font-bold text-slate-900">{title}</h3>
      </div>
      <p className="text-2xl font-extrabold text-indigo-600">
        {typeof value === 'number' ? (value % 1 === 0 ? value : `$${value.toFixed(2)}`) : value}
      </p>
    </div>
  );

  const TransactionModal = ({ transaction, onClose }) => {
    if (!transaction) return null;
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto relative">
          <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
            <XCircle size={32} />
          </button>
          <h3 className="text-2xl font-bold text-slate-900 mb-4 flex items-center gap-2">
            <Info className="text-indigo-600" /> Transaction Details
          </h3>
          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4 text-lg">
              <div className="p-4 bg-slate-50 rounded-lg shadow-inner">
                <span className="font-medium text-slate-700">Customer Name:</span>
                <p className="font-semibold text-slate-900">{transaction.customer}</p>
              </div>
              <div className="p-4 bg-slate-50 rounded-lg shadow-inner">
                <span className="font-medium text-slate-700">Check Number:</span>
                <p className="font-semibold text-slate-900">{transaction.checkNumber}</p>
              </div>
              <div className="p-4 bg-slate-50 rounded-lg shadow-inner">
                <span className="font-medium text-slate-700">Amount Cashed:</span>
                <p className="font-semibold text-green-600">${transaction.cashOut.toFixed(2)}</p>
              </div>
              <div className="p-4 bg-slate-50 rounded-lg shadow-inner">
                <span className="font-medium text-slate-700">Date:</span>
                <p className="font-semibold text-slate-900">{transaction.timestamp}</p>
              </div>
            </div>
            
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4">
              <div className="flex flex-col items-center">
                <h4 className="font-bold text-slate-700 mb-2">Check Image</h4>
                {transaction.checkImage ? (
                  <img src={`data:image/png;base64,${transaction.checkImage}`} alt="Cashed Check" className="rounded-lg border border-slate-300 shadow-md max-w-full" />
                ) : (
                  <div className="bg-slate-100 p-8 rounded-lg text-slate-400 text-center">No image available</div>
                )}
              </div>
              <div className="flex flex-col items-center">
                <h4 className="font-bold text-slate-700 mb-2">ID Image</h4>
                {transaction.idImage ? (
                  <img src={`data:image/png;base64,${transaction.idImage}`} alt="Customer ID" className="rounded-lg border border-slate-300 shadow-md max-w-full" />
                ) : (
                  <div className="bg-slate-100 p-8 rounded-lg text-slate-400 text-center">No image available</div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };
  
  const handleLogin = async (e) => {
    e.preventDefault();
    setAuthError('');
    if (!auth) return;

    try {
      await signInWithEmailAndPassword(auth, email, password);
      setActiveTab('new-transaction');
    } catch (error) {
      console.error("Login failed:", error);
      if (error.code === 'auth/invalid-email' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
        setAuthError('Invalid email or password.');
      } else {
        setAuthError('An unexpected error occurred. Please try again.');
      }
    }
  };

  const handleSignUp = async (e) => {
    e.preventDefault();
    setAuthError('');
    if (!auth) return;

    try {
      await createUserWithEmailAndPassword(auth, email, password);
      // New user is automatically logged in and role is assigned in useEffect
      setActiveTab('new-transaction');
    } catch (error) {
      console.error("Sign up failed:", error);
      if (error.code === 'auth/email-already-in-use') {
        setAuthError('An account with this email already exists.');
      } else if (error.code === 'auth/weak-password') {
        setAuthError('Password is too weak. Please use a stronger password.');
      } else if (error.code === 'auth/operation-not-allowed') {
        setAuthError('Email/Password sign-in is not enabled in Firebase. Please contact support.');
      } else {
        setAuthError('Sign up failed. Please check your information or try again later.');
      }
    }
  };

  const handleLogout = async () => {
    if (!auth) return;

    try {
      await signOut(auth);
      setUser(null);
      setActiveTab('login');
      // Reset all state to clear the dashboard and history
      setCheckAmount('');
      setCustomerName('');
      setCheckType('payroll');
      setFee(0);
      setCashOut(0);
      setTransactions([]);
      setTotalCashedAmount(0);
      setTotalChecksCashed(0);
      setNewCustomers(0);
      setRepeatedCustomers(0);
      setReportStartDate('');
      setReportEndDate('');
      setFilteredTransactions([]);
      setReportData([]);
      setSearchQuery('');
      setSearchResults([]);
      setSelectedTransaction(null);
      setCheckImage(null);
      setIdImage(null);
      setExtractedCheckName('');
      setExtractedCheckNumber('');
      setExtractedIDName('');
      setVerificationStatus('unverified');

    } catch (error) {
      console.error("Logout failed:", error);
    }
  };

  const AuthForm = () => (
    <div className="bg-white p-8 rounded-2xl shadow-xl border border-slate-200 h-fit">
      <h2 className="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
        {isSignUp ? <UserPlus className="text-indigo-600" /> : <LogIn className="text-indigo-600" />} {isSignUp ? 'Create Account' : 'Log In'}
      </h2>
      <form onSubmit={isSignUp ? handleSignUp : handleLogin} className="space-y-6">
        <div>
          <label htmlFor="email" className="block text-sm font-medium text-slate-700 mb-1">
            Email
          </label>
          <input
            type="email"
            id="email"
            className="block w-full rounded-lg border-slate-300 py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
            placeholder="you@example.com"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            required
          />
        </div>
        <div>
          <label htmlFor="password" className="block text-sm font-medium text-slate-700 mb-1">
            Password
          </label>
          <input
            type="password"
            id="password"
            className="block w-full rounded-lg border-slate-300 py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
            placeholder="********"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            required
          />
        </div>
        {authError && (
          <div className="text-center p-3 text-red-600 bg-red-100 rounded-lg font-semibold">
            {authError}
          </div>
        )}
        <button
          type="submit"
          className="w-full flex justify-center items-center gap-2 py-3 px-4 rounded-lg font-bold text-white bg-gradient-blue hover:scale-105 active:scale-100 transition-all duration-300 ease-in-out shadow-lg shadow-indigo-200"
        >
          {isSignUp ? 'Sign Up' : 'Log In'}
        </button>
      </form>
      <div className="mt-6 text-center">
        <button
          onClick={() => setIsSignUp(!isSignUp)}
          className="text-indigo-600 hover:underline font-medium"
        >
          {isSignUp ? 'Already have an account? Log In' : 'Need an account? Sign Up'}
        </button>
      </div>
    </div>
  );

  const NavItem = ({ name, icon, active, onClick, isLogout = false }) => (
    <button
      onClick={() => onClick(name)}
      className={`flex items-center gap-4 py-3 px-4 rounded-xl transition-all duration-200 ease-in-out
      ${active ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-600 hover:bg-slate-200 hover:text-slate-800'}
      ${isLogout ? 'bg-red-500 text-white hover:bg-red-600' : ''}`}
    >
      {icon}
      <span className="font-bold text-lg hidden sm:inline">{name}</span>
    </button>
  );

  const renderContent = () => {
    if (!user) {
      return <AuthForm />;
    }

    switch (activeTab) {
      case 'new-transaction':
        return (
          <>
            <h2 className="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
              <DollarSign className="text-indigo-600" /> New Transaction
            </h2>
            <form onSubmit={handleCashCheck} className="space-y-6">
              <div className="border border-slate-200 p-4 rounded-xl">
                <h3 className="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
                  <Camera className="text-indigo-600" /> Capture & Verify
                </h3>
                
                {!isAuthReady && (
                  <div className="text-center p-8 text-indigo-600 font-semibold bg-indigo-50 rounded-xl">
                    <RotateCcw className="animate-spin inline-block mr-2" />
                    Connecting to database...
                  </div>
                )}
                {isAuthReady && !showCamera && !loading && (
                  <div className="space-y-3">
                    <div className="flex items-center gap-2">
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${checkImage ? 'bg-green-500' : 'bg-slate-400'}`}>
                        {checkImage ? <CheckCircle size={18} /> : '1'}
                      </div>
                      <span className={`text-lg font-medium ${checkImage ? 'text-green-600' : 'text-slate-600'}`}>
                        Check Captured
                      </span>
                      {!checkImage && (
                        <button
                          type="button"
                          onClick={() => startCamera('check')}
                          className="ml-auto py-2 px-4 rounded-lg font-bold text-white bg-gradient-blue hover:scale-105 active:scale-100 transition-all duration-300 ease-in-out shadow-lg shadow-indigo-200 flex items-center justify-center gap-1"
                        >
                          <Scan size={18} /> Capture
                        </button>
                      )}
                    </div>
                    <div className="flex items-center gap-2">
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${idImage ? 'bg-green-500' : 'bg-slate-400'}`}>
                        {idImage ? <CheckCircle size={18} /> : '2'}
                      </div>
                      <span className={`text-lg font-medium ${idImage ? 'text-green-600' : 'text-slate-600'}`}>
                        ID Captured
                      </span>
                      {checkImage && !idImage && (
                        <button
                          type="button"
                          onClick={() => startCamera('id')}
                          className="ml-auto py-2 px-4 rounded-lg font-bold text-white bg-slate-600 hover:scale-105 active:scale-100 transition-all duration-300 ease-in-out shadow-lg shadow-slate-200 flex items-center justify-center gap-1"
                        >
                          <Scan size={18} /> Capture
                        </button>
                      )}
                    </div>
                    {(checkImage || idImage) && (
                      <div className="flex justify-center pt-4">
                         <button
                          type="button"
                          onClick={handleResetCapture}
                          className="py-2 px-4 rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold transition-colors flex items-center gap-2"
                        >
                          <RotateCcw size={18} /> Reset Capture
                        </button>
                      </div>
                    )}
                  </div>
                )}
                {showCamera && (
                  <div className="flex flex-col items-center gap-4 mt-4">
                    <p className="text-sm font-semibold text-slate-700">
                      Capturing {captureStage === 'check' ? 'Check' : 'ID'}...
                    </p>
                    <video ref={videoRef} className="w-full max-w-sm rounded-lg shadow-md border border-slate-300" autoPlay playsInline muted></video>
                    <button
                      type="button"
                      onClick={captureImage}
                      className="py-3 px-6 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold transition-colors shadow-lg shadow-indigo-200"
                    >
                      Capture
                    </button>
                    <button
                      type="button"
                      onClick={stopCamera}
                      className="py-2 px-4 rounded-lg bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                )}
                
                {loading && (
                  <div className="text-center p-4 text-indigo-600 font-semibold">
                    <RotateCcw className="animate-spin inline-block mr-2" />
                    Processing image...
                  </div>
                )}
                {cameraError && (
                  <div className="text-center p-4 text-red-600 bg-red-100 rounded-lg font-semibold">
                    {cameraError}
                  </div>
                )}
                <canvas ref={canvasRef} className="hidden"></canvas>
              </div>
              
              {(extractedCheckName || extractedIDName) && (
                <div className="space-y-3 p-4 bg-slate-100 rounded-xl">
                   <div className="flex justify-between items-center text-slate-600">
                    <span className="font-medium">Name from Check:</span>
                    <span className="font-semibold">{extractedCheckName || 'N/A'}</span>
                  </div>
                   <div className="flex justify-between items-center text-slate-600">
                    <span className="font-medium">Name from ID:</span>
                    <span className="font-semibold">{extractedIDName || 'N/A'}</span>
                  </div>
                  <div className="flex justify-between items-center text-lg font-bold border-t border-slate-300 pt-3">
                    <span>Verification Status:</span>
                    {verificationStatus === 'match' && (
                      <span className="text-green-600 flex items-center gap-1">
                        <BadgeCheck className="h-5 w-5" /> Match
                      </span>
                    )}
                    {verificationStatus === 'mismatch' && (
                      <span className="text-red-600 flex items-center gap-1">
                        <XCircle className="h-5 w-5" /> Mismatch
                      </span>
                    )}
                    {verificationStatus === 'unverified' && (
                      <span className="text-slate-500 flex items-center gap-1">
                        <FileText className="h-5 w-5" /> Unverified
                      </span>
                    )}
                  </div>
                </div>
              )}
              <div>
                <label htmlFor="customerName" className="block text-sm font-medium text-slate-700 mb-1">
                  Customer Name
                </label>
                <div className="relative rounded-lg shadow-sm">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <User className="h-5 w-5 text-slate-400" />
                  </div>
                  <input
                    type="text"
                    id="customerName"
                    className="block w-full rounded-lg border-slate-300 pl-10 pr-4 py-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                    placeholder="e.g., Jane Doe"
                    value={customerName}
                    onChange={(e) => setCustomerName(e.target.value)}
                    disabled={verificationStatus !== 'unverified'}
                  />
                </div>
              </div>
              <div>
                <label htmlFor="checkAmount" className="block text-sm font-medium text-slate-700 mb-1">
                  Check Amount
                </label>
                <div className="relative rounded-lg shadow-sm">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <DollarSign className="h-5 w-5 text-slate-400" />
                  </div>
                  <input
                    type="number"
                    id="checkAmount"
                    className="block w-full rounded-lg border-slate-300 pl-10 pr-4 py-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                    placeholder="0.00"
                    step="0.01"
                    min="0.01"
                    value={checkAmount}
                    onChange={(e) => setCheckAmount(e.target.value)}
                    disabled={!!checkImage}
                  />
                </div>
              </div>
              <div>
                <label htmlFor="checkType" className="block text-sm font-medium text-slate-700 mb-1">
                  Check Type
                </label>
                <select
                  id="checkType"
                  className="block w-full rounded-lg border-slate-300 shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                  value={checkType}
                  onChange={(e) => setCheckType(e.target.value)}
                >
                  <option value="payroll">Payroll (2%)</option>
                  <option value="government">Government (1.5%)</option>
                  <option value="personal">Personal (5%)</option>
                </select>
              </div>
              {isValid && (
                <div className="space-y-3 p-4 bg-slate-100 rounded-xl">
                  <div className="flex justify-between items-center text-slate-600">
                    <span className="font-medium">Fee:</span>
                    <span className="font-semibold text-red-600">-${fee.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between items-center text-lg font-bold text-slate-900 border-t border-slate-300 pt-3">
                    <span>Cash Out:</span>
                    <span>${cashOut.toFixed(2)}</span>
                  </div>
                </div>
              )}
              <button
                type="submit"
                className={`w-full flex justify-center items-center gap-2 py-3 px-4 rounded-lg font-bold text-white transition-all duration-300 ease-in-out ${
                  isValid
                    ? 'bg-gradient-blue hover:scale-105 active:scale-100 shadow-lg shadow-indigo-200'
                    : 'bg-slate-300 cursor-not-allowed'
                }`}
                disabled={!isValid}
              >
                <Receipt /> Cash Check
              </button>
              {isCashed && (
                <div className="flex items-center justify-center gap-2 text-green-600 font-semibold p-3 bg-green-100 rounded-lg">
                  <CheckCircle className="h-5 w-5" />
                  Transaction successful!
                </div>
              )}
            </form>
          </>
        );
      case 'dashboard':
        return (
          <>
            <h2 className="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
              <LayoutDashboard className="text-indigo-600" /> Business Dashboard
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
              <DashboardCard
                title="Checks Cashed"
                value={totalChecksCashed}
                icon={<Receipt size={40} className="text-indigo-600" />}
                className="bg-white"
              />
              <DashboardCard
                title="Total Amount"
                value={totalCashedAmount}
                icon={<DollarSign size={40} className="text-green-600" />}
                className="bg-white"
              />
              <DashboardCard
                title="New Customers"
                value={newCustomers}
                icon={<BadgePlus size={40} className="text-purple-600" />}
                className="bg-white"
              />
              <DashboardCard
                title="Repeated Checks"
                value={repeatedCustomers}
                icon={<ArrowRightCircle size={40} className="text-yellow-600" />}
                className="bg-white"
              />
            </div>
          </>
        );
      case 'reports':
        return (
          <>
            <h2 className="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
              <ClipboardList className="text-indigo-600" /> Reports
            </h2>
            <div className="flex flex-col sm:flex-row gap-4 mb-4">
              <div className="flex-1">
                <label htmlFor="startDate" className="block text-sm font-medium text-slate-700 mb-1">
                  Start Date
                </label>
                <input
                  type="date"
                  id="startDate"
                  className="block w-full rounded-lg border-slate-300 shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                  value={reportStartDate}
                  onChange={(e) => setReportStartDate(e.target.value)}
                />
              </div>
              <div className="flex-1">
                <label htmlFor="endDate" className="block text-sm font-medium text-slate-700 mb-1">
                  End Date
                </label>
                <input
                  type="date"
                  id="endDate"
                  className="block w-full rounded-lg border-slate-300 shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                  value={reportEndDate}
                  onChange={(e) => setReportEndDate(e.target.value)}
                />
              </div>
            </div>
            <button
              onClick={generateReport}
              className="w-full flex justify-center items-center gap-2 py-3 px-4 rounded-lg font-bold text-white bg-indigo-600 hover:scale-105 active:scale-100 transition-all duration-300 ease-in-out shadow-lg shadow-indigo-200"
            >
              Generate Report
            </button>
            {reportData.length > 0 && (
              <div className="mt-6 space-y-4">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <ReportCard
                    title="Checks Cashed"
                    value={filteredTransactions.length}
                    icon={<Receipt size={24} className="text-indigo-600" />}
                    className="bg-slate-50"
                  />
                  <ReportCard
                    title="Total Amount"
                    value={filteredTransactions.reduce((sum, t) => sum + t.amount, 0)}
                    icon={<DollarSign size={24} className="text-green-600" />}
                    className="bg-slate-50"
                  />
                </div>
                <div className="bg-white p-4 rounded-xl shadow-inner flex flex-col items-center">
                    <h4 className="text-lg font-bold text-slate-800 mb-2">Check Type Distribution</h4>
                    <ResponsiveContainer width="100%" height={200}>
                        <PieChart>
                            <Pie
                                data={checkTypePieData}
                                dataKey="value"
                                nameKey="name"
                                cx="50%"
                                cy="50%"
                                outerRadius={80}
                                fill="#8884d8"
                                label
                            >
                                <Cell key="payroll" fill="#4F46E5" />
                                <Cell key="government" fill="#10B981" />
                                <Cell key="personal" fill="#F59E0B" />
                            </Pie>
                            <Tooltip />
                            <Legend />
                        </PieChart>
                    </ResponsiveContainer>
                </div>
                <div className="bg-slate-50 p-4 rounded-xl shadow-inner">
                  <h4 className="text-lg font-bold text-slate-800 mb-2">Daily Amounts Cashed</h4>
                  <ResponsiveContainer width="100%" height={200}>
                    <BarChart data={reportData}>
                      <XAxis dataKey="date" />
                      <YAxis />
                      <Tooltip />
                      <Bar dataKey="amount" fill="#4F46E5" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>
            )}
            {reportData.length === 0 && (reportStartDate || reportEndDate) && (
              <div className="mt-6 text-center p-8 text-slate-500 bg-slate-100 rounded-xl">
                <Info className="h-10 w-10 mx-auto mb-4" />
                <p className="font-semibold">No data found for this date range.</p>
              </div>
            )}
          </>
        );
      case 'history':
        return (
          <>
            <h2 className="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
              <History className="text-indigo-600" /> Transaction History
            </h2>
            <div className="relative mb-6">
              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <Search className="h-5 w-5 text-slate-400" />
              </div>
              <input
                type="text"
                placeholder="Search by name, check number, or amount..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="block w-full rounded-lg border-slate-300 pl-10 pr-4 py-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
              />
            </div>
            {searchResults.length === 0 ? (
              <div className="text-center p-8 text-slate-500 bg-slate-100 rounded-xl">
                <Info className="h-10 w-10 mx-auto mb-4" />
                <p className="font-semibold">No transactions found.</p>
                <p className="text-sm">Try a different search or enter a check to get started!</p>
              </div>
            ) : (
              <ul className="space-y-4">
              {searchResults.map((transaction) => (
                <li 
                  key={transaction.id} 
                  className="bg-slate-50 p-4 rounded-xl shadow-inner border border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors"
                  onClick={() => setSelectedTransaction(transaction)}
                >
                <div className="flex items-center justify-between mb-2">
                  <span className="text-lg font-bold text-slate-900 flex items-center gap-2">
                  <User className="h-5 w-5 text-indigo-600" />
                  {transaction.customer}
                  </span>
                  <span className="text-sm text-slate-500">
                  {transaction.timestamp}
                  </span>
                </div>
                <div className="grid grid-cols-2 gap-2 text-slate-700 text-sm">
                  <div className="flex justify-between items-center">
                  <span className="font-medium">Check Amount:</span>
                  <span className="font-semibold">${transaction.amount.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between items-center">
                  <span className="font-medium">Check Number:</span>
                  <span className="font-semibold">{transaction.checkNumber || 'N/A'}</span>
                  </div>
                  <div className="flex justify-between items-center">
                  <span className="font-medium">Fee:</span>
                  <span className="font-semibold text-red-600">-${transaction.fee.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between items-center">
                  <span className="font-medium">Cash Out:</span>
                  <span className="font-semibold text-green-600">${transaction.cashOut.toFixed(2)}</span>
                  </div>
                </div>
                </li>
              ))}
              </ul>
            )}
          </>
        );
      case 'settings':
        return (
          <>
            <h2 className="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
              <Settings className="text-indigo-600" /> Settings
            </h2>
            <div className="bg-white p-8 rounded-2xl shadow-xl border border-slate-200">
                <h3 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <Database size={24} /> Database & User Information
                </h3>
                <div className="text-sm text-slate-700">
                    <p className="mb-2">This application uses a real-time Firestore database for data persistence.</p>
                    <p className="mb-4">Your data is stored securely under a unique user ID, which is shown below. This ID is essential for retrieving your data across different sessions.</p>
                    <div className="p-4 bg-slate-100 rounded-lg shadow-inner">
                      <p className="font-semibold">User ID:</p>
                      <span className="font-mono text-indigo-600 break-all">{user.uid || 'Loading...'}</span>
                    </div>
                    <div className="p-4 bg-slate-100 rounded-lg shadow-inner mt-4">
                      <p className="font-semibold">Your Role:</p>
                      <span className="font-mono text-indigo-600 break-all">{userRole || 'Loading...'}</span>
                    </div>
                </div>
            </div>
          </>
        );
      case 'admin-dashboard':
        return (
            <>
                <h2 className="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
                    <Users className="text-indigo-600" /> Admin Dashboard
                </h2>
                <div className="bg-white p-8 rounded-2xl shadow-xl border border-slate-200">
                    <div className="relative mb-6">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <Search className="h-5 w-5 text-slate-400" />
                        </div>
                        <input
                            type="text"
                            placeholder="Search all transactions..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="block w-full rounded-lg border-slate-300 pl-10 pr-4 py-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                        />
                    </div>
                    {searchResults.length === 0 ? (
                        <div className="text-center p-8 text-slate-500 bg-slate-100 rounded-xl">
                            <Info className="h-10 w-10 mx-auto mb-4" />
                            <p className="font-semibold">No transactions found.</p>
                        </div>
                    ) : (
                        <ul className="space-y-4">
                        {searchResults.map((transaction) => (
                            <li 
                                key={transaction.id} 
                                className="bg-slate-50 p-4 rounded-xl shadow-inner border border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors"
                                onClick={() => setSelectedTransaction(transaction)}
                            >
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-lg font-bold text-slate-900 flex items-center gap-2">
                                <User className="h-5 w-5 text-indigo-600" />
                                {transaction.customer}
                                </span>
                                <span className="text-sm text-slate-500">
                                {transaction.timestamp}
                                </span>
                            </div>
                            <div className="grid grid-cols-2 gap-2 text-slate-700 text-sm">
                                <div className="flex justify-between items-center">
                                <span className="font-medium">Check Amount:</span>
                                <span className="font-semibold">${transaction.amount.toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                <span className="font-medium">Check Number:</span>
                                <span className="font-semibold">{transaction.checkNumber || 'N/A'}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                <span className="font-medium">Processed by User:</span>
                                <span className="font-semibold">{transaction.userId}</span>
                                </div>
                            </div>
                            </li>
                        ))}
                        </ul>
                    )}
                </div>
            </>
        );
      default:
        return null;
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex flex-col sm:flex-row">
      <script src="https://cdn.tailwindcss.com"></script>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" />
      <style>
        {`
        body { font-family: 'Inter', sans-serif; }
        .bg-gradient-blue {
          background-image: linear-gradient(to right, #4F46E5, #3B82F6);
        }
        .bg-gradient-green {
          background-image: linear-gradient(to right, #10B981, #059669);
        }
        `}
      </style>

      {/* Sidebar Navigation */}
      <nav className="p-4 sm:p-6 bg-white shadow-xl border-r border-slate-200 flex sm:flex-col items-center justify-between sm:justify-start w-full sm:w-64">
        <div className="mb-6 hidden sm:block">
          <h1 className="text-2xl font-bold text-slate-900">Wrangler</h1>
          <p className="text-sm text-slate-500">Check Cashing</p>
        </div>
        <div className="flex sm:flex-col gap-2 w-full sm:w-auto overflow-x-auto pb-2 sm:pb-0">
          {user && (
            <>
              <NavItem
                name="New Transaction"
                icon={<Home size={24} />}
                active={activeTab === 'new-transaction'}
                onClick={setActiveTab}
              />
              <NavItem
                name="Dashboard"
                icon={<LayoutDashboard size={24} />}
                active={activeTab === 'dashboard'}
                onClick={setActiveTab}
              />
              <NavItem
                name="Reports"
                icon={<ClipboardList size={24} />}
                active={activeTab === 'reports'}
                onClick={setActiveTab}
              />
              <NavItem
                name="History"
                icon={<History size={24} />}
                active={activeTab === 'history'}
                onClick={setActiveTab}
              />
              {isAdmin && (
                <NavItem
                  name="Admin Dashboard"
                  icon={<Users size={24} />}
                  active={activeTab === 'admin-dashboard'}
                  onClick={setActiveTab}
                />
              )}
              <NavItem
                name="Settings"
                icon={<Settings size={24} />}
                active={activeTab === 'settings'}
                onClick={setActiveTab}
              />
              <div className="mt-auto pt-4 hidden sm:block">
                <NavItem
                  name="Logout"
                  icon={<LogOut size={24} />}
                  active={false}
                  onClick={handleLogout}
                  isLogout={true}
                />
              </div>
            </>
          )}
          {!user && (
            <div className="w-full">
              <NavItem
                name="Login"
                icon={<LogIn size={24} />}
                active={activeTab === 'login'}
                onClick={() => setActiveTab('login')}
              />
            </div>
          )}
        </div>
      </nav>

      {/* Main Content */}
      <main className="flex-1 p-4 sm:p-8">
        <header className="block sm:hidden text-center py-4">
          <h1 className="text-2xl font-bold text-slate-900">Wrangler</h1>
          <p className="text-sm text-slate-500">Check Cashing</p>
          {user && (
            <button onClick={handleLogout} className="mt-2 py-2 px-4 rounded-lg bg-red-500 text-white font-bold transition-colors">
              Logout
            </button>
          )}
        </header>

        <div className="w-full max-w-4xl mx-auto">
          {renderContent()}
        </div>
      </main>
      
      <TransactionModal 
        transaction={selectedTransaction} 
        onClose={() => setSelectedTransaction(null)} 
      />
    </div>
  );
};

export default App;
